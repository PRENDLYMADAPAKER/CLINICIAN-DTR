<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>User Panel - DTR</title>
  <script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
      authDomain: "dtr-project-66048.firebaseapp.com",
      databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dtr-project-66048",
      storageBucket: "dtr-project-66048.firebasestorage.app",
      messagingSenderId: "271445506225",
      appId: "1:271445506225:web:fcb04d0454e1302de14a90",
      measurementId: "G-R22CLKSPCP"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Handle registration
    document.addEventListener("DOMContentLoaded", () => {
      const regForm = document.getElementById("registerForm");
      const loginForm = document.getElementById("loginForm");
      const messageBox = document.getElementById("message");

      regForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("regName").value.trim();
        const email = document.getElementById("regEmail").value.trim();
        const password = document.getElementById("regPassword").value;

        try {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const uid = userCredential.user.uid;
          
          // Generate QR link
          const qrLink = `${window.location.origin}/timein.html?uid=${uid}`;
          
          // Save to DB
          await set(ref(db, "users/" + uid), {
            name: name,
            email: email,
            qrLink: qrLink
          });

          messageBox.style.color = "green";
          messageBox.textContent = "Account created successfully! Redirecting...";
          setTimeout(() => {
            window.location.href = "user-panel.html";
          }, 1500);
        } catch (error) {
          messageBox.style.color = "red";
          messageBox.textContent = error.message;
        }
      });

      // Handle login
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("logEmail").value.trim();
        const password = document.getElementById("logPassword").value;
        try {
          await signInWithEmailAndPassword(auth, email, password);
          messageBox.style.color = "green";
          messageBox.textContent = "Login successful! Redirecting...";
          setTimeout(() => {
            window.location.href = "user-panel.html";
          }, 1000);
        } catch (error) {
          messageBox.style.color = "red";
          messageBox.textContent = error.message;
        }
      });
    });
  </script>
</head>
<body style="font-family:sans-serif; text-align:center; padding:20px;">
  <h1>DTR - User Portal</h1>
  <p id="message"></p>

  <h2>Create Account</h2>
  <form id="registerForm">
    <input type="text" id="regName" placeholder="Full Name" required><br><br>
    <input type="email" id="regEmail" placeholder="Email" required><br><br>
    <input type="password" id="regPassword" placeholder="Password" required><br><br>
    <button type="submit">Register</button>
  </form>

  <hr>

  <h2>Login</h2>
  <form id="loginForm">
    <input type="email" id="logEmail" placeholder="Email" required><br><br>
    <input type="password" id="logPassword" placeholder="Password" required><br><br>
    <button type="submit">Login</button>
  </form>
</body>
</html>
