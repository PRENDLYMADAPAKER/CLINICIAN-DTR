<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DTR — User Panel (QR = Time In key)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#071227;--card:#0f1724;--accent:#06b6d4;--muted:#9ca3af;color:white}
    body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#071427,#071427);color:var(--muted);padding:28px;display:flex;justify-content:center}
    .card{background:rgba(255,255,255,0.03);padding:20px;border-radius:12px;max-width:420px;width:100%;box-shadow:0 8px 30px rgba(2,6,23,0.7)}
    h1{color:#e6eef8;margin:0 0 12px;font-size:20px}
    input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);margin:8px 0;background:transparent;color:inherit}
    button{padding:10px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent),#60a5fa);color:#021124;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    #qr {margin:12px auto;width:180px;height:180px;background:white;border-radius:8px;padding:6px;display:flex;align-items:center;justify-content:center}
    table{width:100%;border-collapse:collapse;margin-top:12px;color:var(--muted)}
    th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px}
    .row{display:flex;gap:8px}
    .small{font-size:13px}
    .error{color:#ffb4b4}
    .success{color:#b7f5d0}
  </style>
</head>
<body>
  <div class="card">
    <h1>DTR — User Panel</h1>

    <div id="authArea">
      <div id="forms">
        <div id="registerForm">
          <div class="muted">Create account</div>
          <input id="regName" placeholder="Full name" />
          <input id="regEmail" type="email" placeholder="Email" />
          <input id="regPass" type="password" placeholder="Password (6+ chars)" />
          <div class="row">
            <button id="registerBtn">Create Account</button>
            <button id="gotoLoginBtn" style="background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04)">Login</button>
          </div>
        </div>

        <div id="loginForm" style="display:none;margin-top:12px">
          <div class="muted">Login</div>
          <input id="loginEmail" type="email" placeholder="Email" />
          <input id="loginPass" type="password" placeholder="Password" />
          <div class="row">
            <button id="loginBtn">Login</button>
            <button id="gotoRegisterBtn" style="background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04)">Create</button>
          </div>
        </div>
      </div>

      <p id="message" class="muted small" style="margin-top:12px"></p>
    </div>

    <div id="userPanel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="muted">Signed in as</div>
          <div id="nameDisplay" style="color:#e6eef8;font-weight:600"></div>
          <div id="emailDisplay" class="muted small"></div>
        </div>
        <div>
          <button id="logoutBtn" style="background:#ff6b6b">Logout</button>
        </div>
      </div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0" />

      <div class="muted small">Your QR (show this to admin to Time In)</div>
      <div id="qr" aria-hidden="true"></div>

      <div style="margin-top:12px">
        <div class="muted small">Your Time-In history</div>
        <table aria-live="polite">
          <thead><tr><th>Date</th><th>Time In</th></tr></thead>
          <tbody id="recordsBody"><tr><td colspan="2" class="muted small">No records yet</td></tr></tbody>
        </table>
      </div>

      <p class="muted small" style="margin-top:10px">QR is the only way to Time In — admin scans it to record your attendance.</p>
    </div>
  </div>

  <!-- QR and Firebase libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js"></script>

  <script>
    // ===== YOUR FIREBASE CONFIG (kept from your project) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBYYZrsZECXM2UpW4-38sGQLaPqAqkjSWI",
      authDomain: "dtr-project-66048.firebaseapp.com",
      databaseURL: "https://dtr-project-66048-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "dtr-project-66048",
      storageBucket: "dtr-project-66048.appspot.com", // use .appspot.com
      messagingSenderId: "271445506225",
      appId: "1:271445506225:web:fcb04d0454e1302de14a90",
      measurementId: "G-R22CLKSPCP"
    };
    // ========================================================

    // Init
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // UI refs
    const registerBtn = document.getElementById('registerBtn');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const gotoLoginBtn = document.getElementById('gotoLoginBtn');
    const gotoRegisterBtn = document.getElementById('gotoRegisterBtn');
    const messageEl = document.getElementById('message');

    // toggle forms
    gotoLoginBtn.onclick = () => { document.getElementById('registerForm').style.display='none'; document.getElementById('loginForm').style.display='block'; messageEl.textContent=''; }
    gotoRegisterBtn.onclick = () => { document.getElementById('loginForm').style.display='none'; document.getElementById('registerForm').style.display='block'; messageEl.textContent=''; }

    // helper: format date
    function pad(n){return n<10? '0'+n : n}
    function ymd(d){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())}

    // Register flow: create account, immediately write profile (while authenticated)
    registerBtn.onclick = async () => {
      const name = document.getElementById('regName').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const pass = document.getElementById('regPass').value;
      if(!name || !email || !pass){ messageEl.textContent = 'Fill all fields'; messageEl.className='error'; return; }

      messageEl.textContent = 'Creating account...'; messageEl.className='muted';
      try{
        const uc = await auth.createUserWithEmailAndPassword(email, pass);
        const uid = uc.user.uid;

        // QR payload is UID (admin scanner will read uid)
        const qrPayload = uid;

        // Save profile under users/{uid}
        await db.ref('users/' + uid + '/profile').set({ name, email, uid, qrPayload, createdAt: new Date().toISOString() });

        messageEl.textContent = 'Account created — logged in.'; messageEl.className='success';
        // onAuthStateChanged will render user panel
      }catch(err){
        messageEl.textContent = err.message; messageEl.className='error';
      }
    };

    // Login
    loginBtn.onclick = async () => {
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPass').value;
      if(!email || !pass){ messageEl.textContent='Enter credentials'; messageEl.className='error'; return; }
      try{
        await auth.signInWithEmailAndPassword(email, pass);
        messageEl.textContent=''; 
      }catch(err){
        messageEl.textContent = err.message; messageEl.className='error';
      }
    };

    // Logout
    logoutBtn.onclick = () => auth.signOut();

    // show user panel when signed in
    auth.onAuthStateChanged(async user => {
      if(user){
        // show panel
        document.getElementById('authArea').style.display='none';
        document.getElementById('userPanel').style.display='block';

        // display name/email from profile or fallback
        const profileSnap = await db.ref('users/' + user.uid + '/profile').get();
        const profile = profileSnap.exists() ? profileSnap.val() : { name: user.email, email: user.email, uid: user.uid };
        document.getElementById('nameDisplay').textContent = profile.name || profile.email;
        document.getElementById('emailDisplay').textContent = profile.email || '';

        // Generate QR (payload = uid)
        document.getElementById('qr').innerHTML = '';
        new QRCode(document.getElementById('qr'), { text: user.uid, width: 168, height: 168 });

        // Listen for this user's DTR records (written by admin scanner)
        const recRef = db.ref('users/' + user.uid + '/dtr');
        recRef.off(); // remove previous listeners
        recRef.on('value', snap => {
          const body = document.getElementById('recordsBody');
          body.innerHTML = '';
          if(!snap.exists()){
            body.innerHTML = '<tr><td colspan="2" class="muted small">No records yet</td></tr>';
            return;
          }
          const data = snap.val();
          const rows = Object.keys(data).sort().reverse(); // latest first
          for(const date of rows){
            body.innerHTML += `<tr><td>${date}</td><td>${data[date].timeIn}</td></tr>`;
          }
        });

      } else {
        // show auth area
        document.getElementById('authArea').style.display='block';
        document.getElementById('userPanel').style.display='none';
        messageEl.textContent = '';
      }
    });

    // small UX: Enter key submits login/register
    document.addEventListener('keydown', e => { if(e.key === 'Enter'){ const regShown = document.getElementById('registerForm').style.display !== 'none'; if(regShown) registerBtn.click(); else loginBtn.click(); }});
  </script>
</body>
</html>
